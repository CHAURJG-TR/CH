<!doctype html>
<html lang="zh-TW">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Schedule Audio Player</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
      overflow: auto;
    }

    html {
      height: 100%;
      width: 100%;
    }

    .app-wrapper {
      width: 100%;
      min-height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 24px;
    }

    .player-container {
      background: white;
      border-radius: 24px;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .title {
      font-size: 32px;
      font-weight: bold;
      color: #2d3748;
      text-align: center;
      margin-bottom: 12px;
    }

    .subtitle {
      font-size: 16px;
      color: #718096;
      text-align: center;
      margin-bottom: 32px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e2e8f0;
    }

    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: 500;
      color: #718096;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      margin-bottom: -2px;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .settings-section {
      background: #f7fafc;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .settings-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .setting-item {
      flex: 1;
      min-width: 120px;
    }

    .setting-label {
      display: block;
      font-size: 14px;
      color: #4a5568;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .setting-input, .setting-select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .setting-input:focus, .setting-select:focus {
      outline: none;
      border-color: #667eea;
    }

    .phrase-list {
      margin-bottom: 24px;
    }

    .phrase-item {
      background: #f7fafc;
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .phrase-item:hover {
      background: #edf2f7;
      border-color: #667eea;
    }

    .phrase-item.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .phrase-icon {
      font-size: 24px;
    }

    .phrase-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .phrase-text {
      font-size: 18px;
      font-weight: 500;
    }

    .phrase-mode {
      font-size: 12px;
      opacity: 0.8;
    }

    .phrase-actions {
      display: flex;
      gap: 8px;
    }

    .record-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .record-btn:hover {
      background: #dc2626;
    }

    .record-btn.recording {
      background: #10b981;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .control-panel {
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      margin-bottom: 24px;
    }

    .control-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .control-btn:hover {
      background: #5568d3;
      transform: scale(1.05);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn.stop {
      background: #fc8181;
      box-shadow: 0 4px 12px rgba(252, 129, 129, 0.4);
    }

    .control-btn.stop:hover {
      background: #f56565;
    }

    .control-btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status {
      text-align: center;
      font-size: 14px;
      color: #718096;
      padding: 16px;
      background: #f7fafc;
      border-radius: 12px;
    }

    .status.playing {
      background: #c6f6d5;
      color: #2f855a;
    }

    .status.recording {
      background: #fed7d7;
      color: #c53030;
    }

    .progress-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
      font-size: 14px;
      color: #667eea;
      font-weight: 600;
    }

    .schedule-form {
      background: #f7fafc;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .add-schedule-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .add-schedule-btn:hover {
      background: #5568d3;
    }

    .add-schedule-btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .schedule-item {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s ease;
    }

    .schedule-item.disabled {
      opacity: 0.5;
    }

    .schedule-info {
      flex: 1;
      display: grid;
      grid-template-columns: auto auto 1fr auto;
      gap: 16px;
      align-items: center;
    }

    .schedule-day {
      font-weight: 600;
      color: #667eea;
      font-size: 16px;
    }

    .schedule-period {
      font-weight: 500;
      color: #4a5568;
      font-size: 14px;
    }

    .schedule-phrase {
      color: #718096;
      font-size: 14px;
    }

    .schedule-time {
      color: #2d3748;
      font-weight: 600;
      font-size: 16px;
      font-family: monospace;
    }

    .schedule-actions {
      display: flex;
      gap: 8px;
    }

    .toggle-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .toggle-btn.disabled {
      background: #cbd5e0;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .auto-status {
      background: #e0e7ff;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 20px;
    }

    .auto-status-title {
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 4px;
    }

    .auto-status-time {
      font-size: 20px;
      font-weight: bold;
      color: #2d3748;
      font-family: monospace;
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .timer-display-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 48px;
      text-align: center;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }

    .timer-display {
      font-size: 96px;
      font-weight: bold;
      color: white;
      font-family: 'Courier New', monospace;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin-bottom: 32px;
      letter-spacing: 8px;
    }

    .timer-controls {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    .timer-btn {
      background: white;
      color: #667eea;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 110px;
      justify-content: center;
    }

    .timer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .timer-btn:active {
      transform: translateY(0);
    }

    .timer-btn.start {
      background: #10b981;
      color: white;
    }

    .timer-btn.pause {
      background: #f59e0b;
      color: white;
    }

    .timer-btn.reset {
      background: #ef4444;
      color: white;
    }

    .timer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .timer-btn-icon {
      font-size: 20px;
    }

    .timer-presets {
      margin-bottom: 24px;
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .preset-btn {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      font-size: 16px;
      font-weight: 500;
      color: #2d3748;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .preset-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .timer-custom-section {
      background: #f7fafc;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .custom-time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .time-input-group {
      display: flex;
      flex-direction: column;
    }

    .set-timer-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .set-timer-btn:hover {
      background: #5568d3;
    }

    .timer-settings-section {
      background: #f7fafc;
      border-radius: 16px;
      padding: 24px;
    }

    .timer-alert-option {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: white;
      border-radius: 8px;
    }

    .timer-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .timer-checkbox-label {
      font-size: 16px;
      color: #2d3748;
      cursor: pointer;
      font-weight: 500;
    }

    .timer-phrase-select-wrapper {
      display: flex;
      flex-direction: column;
    }

    .timer-display.running {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    .timer-display.finished {
      animation: flash 0.5s ease-in-out 3;
      color: #fbbf24;
    }

    @keyframes pulse-glow {
      0%, 100% { text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
      50% { text-shadow: 0 4px 24px rgba(255, 255, 255, 0.6); }
    }

    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-wrapper">
   <div class="player-container">
    <h1 class="title" id="player-title">èª²ï¿½ï¿½ï¿½æé†’æ’­æ”¾å™¨</h1>
    <p class="subtitle">å¯æ‰‹å‹•æ’­æ”¾æˆ–è¨­å®šï¿½ï¿½ï¿½è¡¨è‡ªå‹•æ’­æ”¾</p>
    <div class="tabs"><button class="tab-btn active" data-tab="manual">æ‰‹å‹•æ’­æ”¾</button> <button class="tab-btn" data-tab="schedule">èª²è¡¨è¨­å®š</button> <button class="tab-btn" data-tab="timer">è¨ˆæ™‚ç³»çµ±</button> <button class="tab-btn" data-tab="decibel">åˆ†è²è¨ˆ</button>
    </div><!-- Manual Tab -->
    <div class="tab-content active" id="manual-tab">
     <div class="settings-section">
      <div class="settings-title">
       âš™ï¸ æ’­æ”¾è¨­å®š
      </div>
      <div class="settings-row">
       <div class="setting-item"><label class="setting-label" for="interval-input">é–“éš”ç§’æ•¸</label> <input type="number" id="interval-input" class="setting-input" min="1" max="60" value="3">
       </div>
       <div class="setting-item"><label class="setting-label" for="repeat-input">é‡è¤‡ï¿½ï¿½ï¿½ï¿½æ•¸ï¼ˆ0=ç„¡ï¿½ï¿½ï¿½ï¼‰</label> <input type="number" id="repeat-input" class="setting-input" min="0" max="999" value="0">
       </div>
      </div>
      <div class="settings-row">
       <div class="setting-item"><label class="setting-label" for="play-duration-input">æ’­æ”¾æ™‚é•·ï¼ˆç§’ï¼‰</label> <input type="number" id="play-duration-input" class="setting-input" min="0" max="3600" value="0" placeholder="0 = ä¸é™åˆ¶">
       </div>
       <div class="setting-item"><label class="setting-label" style="opacity: 0.7; font-size: 12px;">è¨­å®šç‚º 0 è¡¨ç¤ºä¸é™åˆ¶æ™‚é–“</label>
       </div>
      </div>
     </div>
     <div class="phrase-list" id="phrase-list">
      <div class="phrase-item" data-phrase="0"><span class="phrase-icon">ğŸ“¢</span>
       <div class="phrase-content"><span class="phrase-text" id="phrase-text-0">éœï¿½ï¿½ä¾†</span> <span class="phrase-mode" id="phrase-mode-0">æ–‡å­—è½‰èªéŸ³</span>
       </div>
       <div class="phrase-actions"><button class="record-btn" data-phrase="0"> <span>ğŸ¤</span> <span>éŒ„éŸ³</span> </button>
       </div>
      </div>
      <div class="phrase-item" data-phrase="1"><span class="phrase-icon">ğŸª‘</span>
       <div class="phrase-content"><span class="phrase-text" id="phrase-text-1">å›åº§ä½</span> <span class="phrase-mode" id="phrase-mode-1">æ–‡å­—è½‰èªéŸ³</span>
       </div>
       <div class="phrase-actions"><button class="record-btn" data-phrase="1"> <span>ğŸ¤</span> <span>éŒ„éŸ³</span> </button>
       </div>
      </div>
      <div class="phrase-item" data-phrase="2"><span class="phrase-icon">ğŸ“</span>
       <div class="phrase-content"><span class="phrase-text" id="phrase-text-2">å°ˆå¿ƒä¸Šèª²</span> <span class="phrase-mode" id="phrase-mode-2">æ–‡å­—è½‰èªéŸ³</span>
       </div>
       <div class="phrase-actions"><button class="record-btn" data-phrase="2"> <span>ğŸ¤</span> <span>éŒ„éŸ³</span> </button>
       </div>
      </div>
      <div class="phrase-item" data-phrase="3"><span class="phrase-icon">ğŸ¤«</span>
       <div class="phrase-content"><span class="phrase-text" id="phrase-text-3">ä¸è¦åµ</span> <span class="phrase-mode" id="phrase-mode-3">æ–‡å­—è½‰èªéŸ³</span>
       </div>
       <div class="phrase-actions"><button class="record-btn" data-phrase="3"> <span>ğŸ¤</span> <span>éŒ„ï¿½ï¿½ï¿½</span> </button>
       </div>
      </div>
      <div class="phrase-item" data-phrase="4"><span class="phrase-icon">ğŸš¶</span>
       <div class="phrase-content"><span class="phrase-text" id="phrase-text-4">å‡ºå»æ’éšŠ</span> <span class="phrase-mode" id="phrase-mode-4">æ–‡å­—è½‰èªéŸ³</span>
       </div>
       <div class="phrase-actions"><button class="record-btn" data-phrase="4"> <span>ğŸ¤</span> <span>éŒ„éŸ³</span> </button>
       </div>
      </div>
      <div class="phrase-item" data-phrase="5"><span class="phrase-icon">ğŸ±</span>
       <div class="phrase-content"><span class="phrase-text" id="phrase-text-5">æŠ¬é¤</span> <span class="phrase-mode" id="phrase-mode-5">æ–‡å­—è½‰èªéŸ³</span>
       </div>
       <div class="phrase-actions"><button class="record-btn" data-phrase="5"> <span>ğŸ¤</span> <span>éŒ„ï¿½ï¿½ï¿½ï¿½ï¿½</span> </button>
       </div>
      </div>
     </div>
     <div class="control-panel"><button class="control-btn" id="play-btn" aria-label="æ’­æ”¾">â–¶ï¸</button> <button class="control-btn stop" id="stop-btn" aria-label="åœæ­¢">ï¿½ï¿½ï¿½ï¸</button>
     </div>
     <div class="status" id="status">
      è«‹é¸ï¿½ï¿½ï¿½ä¸€å€‹æé†’èªå¥å¾ŒæŒ‰æ’­æ”¾
     </div>
     <div class="progress-info" id="progress-info" style="display: none;"><span id="play-count">0</span> <span>/</span> <span id="total-count">âˆ</span>
     </div>
    </div><!-- Timer Tab -->
    <div class="tab-content" id="timer-tab">
     <div class="timer-display-section">
      <div class="timer-display" id="timer-display">
       00:00
      </div>
      <div class="timer-controls"><button class="timer-btn start" id="timer-start-btn"> <span class="timer-btn-icon">â–¶ï¸</span> <span class="timer-btn-text">é–‹å§‹</span> </button> <button class="timer-btn pause" id="timer-pause-btn"> <span class="timer-btn-icon">â¸ï¸</span> <span class="timer-btn-text">æš«åœ</span> </button> <button class="timer-btn reset" id="timer-reset-btn"> <span class="timer-btn-icon">ğŸ”„</span> <span class="timer-btn-text">é‡ç½®</span> </button>
      </div>
     </div>
     <div class="timer-presets">
      <div class="settings-title">
       â±ï¸ å¿«é€Ÿè¨­å®š
      </div>
      <div class="preset-buttons"><button class="preset-btn" data-minutes="1">1 åˆ†é˜</button> <button class="preset-btn" data-minutes="3">3 åˆ†é˜</button> <button class="preset-btn" data-minutes="5">5 åˆ†é˜</button> <button class="preset-btn" data-minutes="10">10 åˆ†é˜</button> <button class="preset-btn" data-minutes="15">15 åˆ†é˜</button> <button class="preset-btn" data-minutes="30">30 åˆ†é˜</button>
      </div>
     </div>
     <div class="timer-custom-section">
      <div class="settings-title">
       âš™ï¿½ï¿½ï¿½ è‡ªè¨‚æ™‚é–“
      </div>
      <div class="custom-time-inputs">
       <div class="time-input-group"><label class="setting-label" for="timer-minutes">åˆ†é˜</label> <input type="number" id="timer-minutes" class="setting-input" min="0" max="99" value="5">
       </div>
       <div class="time-input-group"><label class="setting-label" for="timer-seconds">ï¿½ï¿½æ•¸</label> <input type="number" id="timer-seconds" class="setting-input" min="0" max="59" value="0">
       </div>
      </div><button class="set-timer-btn" id="set-timer-btn">è¨­å®šè¨ˆæ™‚å™¨</button>
     </div>
     <div class="timer-settings-section">
      <div class="settings-title">
       ğŸ”” æé†’è¨­å®š
      </div>
      <div class="timer-alert-option"><input type="checkbox" id="timer-alert-enabled" class="timer-checkbox" checked> <label for="timer-alert-enabled" class="timer-checkbox-label">æ™‚é–“åˆ°æ™‚æ’­æ”¾æé†’</label>
      </div>
      <div class="timer-phrase-select-wrapper"><label class="setting-label" for="timer-alert-phrase">æé†’èªå¥</label> <select id="timer-alert-phrase" class="setting-select"> <option value="0">ğŸ“¢ éœä¸‹ä¾†</option> <option value="1">ğŸª‘ å›åº§ä½</option> <option value="2">ğŸ“ å°ˆå¿ƒä¸Šèª²</option> <option value="3">ğŸ¤« ä¸è¦åµ</option> <option value="4">ğŸš¶ å‡ºå»æ’éšŠ</option> <option value="5">ğŸ± æŠ¬é¤</option> </select>
      </div>
     </div>
    </div><!-- Decibel Tab -->
    <div class="tab-content" id="decibel-tab">
     <div class="timer-display-section">
      <div class="timer-display" id="decibel-display" style="font-size: 80px;">
       -- dB
      </div>
      <div class="timer-controls"><button class="timer-btn start" id="decibel-start-btn"> <span class="timer-btn-icon">ğŸ¤</span> <span class="timer-btn-text">é–‹å§‹ç›£æ¸¬</span> </button> <button class="timer-btn stop" id="decibel-stop-btn"> <span class="timer-btn-icon">â¹ï¸</span> <span class="timer-btn-text">åœæ­¢</span> </button>
      </div>
     </div>
     <div class="timer-settings-section">
      <div class="settings-title">
       âš™ï¸ è‡ªå‹•æé†’è¨­å®š
      </div>
      <div class="timer-alert-option"><input type="checkbox" id="decibel-alert-enabled" class="timer-checkbox" checked> <label for="decibel-alert-enabled" class="timer-checkbox-label">éŸ³é‡è¶…æ¨™æ™‚è‡ªå‹•æ’­æ”¾æé†’</label>
      </div>
      <div class="settings-row">
       <div class="setting-item"><label class="setting-label" for="decibel-threshold">åˆ†è²é–¾å€¼</label> <input type="number" id="decibel-threshold" class="setting-input" min="50" max="100" value="80">
       </div>
       <div class="setting-item"><label class="setting-label" for="decibel-cooldown">å†·å»æ™‚é–“ï¼ˆç§’ï¼‰</label> <input type="number" id="decibel-cooldown" class="setting-input" min="5" max="300" value="10">
       </div>
      </div>
      <div class="timer-phrase-select-wrapper"><label class="setting-label" for="decibel-alert-phrase">æé†’èªå¥</label> <select id="decibel-alert-phrase" class="setting-select"> <option value="0">ğŸ“¢ éœä¸‹ä¾†</option> <option value="1">ğŸª‘ å›åº§ä½</option> <option value="2">ğŸ“ å°ˆå¿ƒä¸Šèª²</option> <option value="3" selected>ğŸ¤« ä¸è¦åµ</option> <option value="4">ğŸš¶ å‡ºå»æ’éšŠ</option> <option value="5">ğŸ± æŠ¬é¤</option> </select>
      </div>
     </div>
     <div class="timer-custom-section">
      <div class="settings-title">
       ğŸ“Š åˆ†è²èªªæ˜
      </div>
      <div style="padding: 16px; background: white; border-radius: 8px;">
       <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;"><span style="font-size: 20px;">ğŸŸ¢</span> <span style="font-weight: 500;">30-50 dBï¼šå®‰éœç’°å¢ƒï¼ˆåœ–æ›¸é¤¨ï¼‰</span>
       </div>
       <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;"><span style="font-size: 20px;">ğŸŸ¡</span> <span style="font-weight: 500;">50-70 dBï¼šæ­£å¸¸äº¤è«‡</span>
       </div>
       <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;"><span style="font-size: 20px;">ğŸŸ </span> <span style="font-weight: 500;">70-85 dBï¼šåµé›œç’°å¢ƒ</span>
       </div>
       <div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 20px;">ğŸ”´</span> <span style="font-weight: 500;">85+ dBï¼šéå¸¸åµé¬§</span>
       </div>
      </div>
     </div>
     <div class="auto-status" id="decibel-status" style="display: none;">
      <div class="auto-status-title">
       ğŸ”” æœ€è¿‘æé†’
      </div>
      <div class="auto-status-time" id="decibel-last-alert">
       å°šæœªè§¸ç™¼
      </div>
     </div>
    </div><!-- Schedule Tab -->
    <div class="tab-content" id="schedule-tab">
     <div class="auto-status">
      <div class="auto-status-title">
       ğŸ• ç›®å‰æ™‚é–“
      </div>
      <div class="auto-status-time" id="current-time">
       --:--:--
      </div>
     </div>
     <div class="schedule-form">
      <div class="settings-title">
       â• æ–°å¢èª²è¡¨æ’ç¨‹
      </div>
      <div class="form-row">
       <div class="form-group"><label class="setting-label" for="schedule-day">æ˜ŸæœŸ</label> <select id="schedule-day" class="setting-select"> <option value="æ˜ŸæœŸä¸€">æ˜ŸæœŸä¸€</option> <option value="æ˜ŸæœŸäºŒ">æ˜ŸæœŸäºŒ</option> <option value="æ˜ŸæœŸä¸‰">æ˜ŸæœŸä¸‰</option> <option value="æ˜ŸæœŸå››">æ˜Ÿï¿½ï¿½ï¿½ï¿½ï¿½</option> <option value="æ˜ŸæœŸäº”">æ˜ŸæœŸäº”</option> <option value="æ˜ŸæœŸå…­">æ˜ŸæœŸå…­</option> <option value="æ˜ŸæœŸï¿½ï¿½ï¿½">æ˜ŸæœŸæ—¥</option> </select>
       </div>
       <div class="form-group"><label class="setting-label" for="schedule-period">ç¬¬å¹¾ç¯€</label> <select id="schedule-period" class="setting-select"> <option value="ç¬¬1ç¯€">ç¬¬1ç¯€</option> <option value="ç¬¬2ç¯€">ç¬¬2ç¯€</option> <option value="ç¬¬3ç¯€">ç¬¬3ç¯€</option> <option value="ç¬¬4ç¯€">ç¬¬4ç¯€</option> <option value="ç¬¬5ç¯€">ç¬¬5ç¯€</option> <option value="ç¬¬6ç¯€">ç¬¬6ç¯€</option> <option value="ç¬¬7ç¯€">ç¬¬7ï¿½ï¿½ï¿½</option> <option value="ç¬¬8ç¯€">ç¬¬8ç¯€</option> </select>
       </div>
       <div class="form-group"><label class="setting-label" for="schedule-time">æ™‚é–“</label> <input type="time" id="schedule-time" class="setting-input" required>
       </div>
       <div class="form-group"><label class="setting-label" for="schedule-phrase-select">æé†’èªå¥</label> <select id="schedule-phrase-select" class="setting-select"> <option value="0">ğŸ“¢ éœä¸‹ä¾†</option> <option value="1">ğŸª‘ å›åº§ä½</option> <option value="2">ğŸ“ å°ˆå¿ƒä¸Šèª²</option> <option value="3">ğŸ¤« ä¸è¦åµ</option> <option value="4">ğŸš¶ å‡ºå»æ’éšŠ</option> <option value="5">ğŸ± æŠ¬é¤</option> </select>
       </div>
      </div><button class="add-schedule-btn" id="add-schedule-btn"> æ–°å¢æ’ç¨‹ </button>
     </div>
     <div class="settings-title">
      ğŸ“‹ å·²è¨­å®šçš„èª²è¡¨
     </div>
     <div class="schedule-list" id="schedule-list">
      <div class="empty-state">
       å°šæœªæ–°å¢ä»»ä½•æ’ç¨‹<br>
        è«‹ï¿½ï¿½ä¸Šæ–¹è¡¨å–®æ–°å¢èª²è¡¨æ’ç¨‹
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      player_title: "èª²å ‚æé†’æ’­æ”¾å™¨",
      phrase_1: "éœä¸‹ä¾†",
      phrase_2: "å›åº§ä½",
      phrase_3: "å°ˆå¿ƒä¸Šèª²",
      phrase_4: "ä¸è¦åµ",
      phrase_5: "å‡ºå»æ’éšŠ",
      phrase_6: "æŠ¬é¤",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#2d3748",
      primary_action_color: "#667eea",
      secondary_action_color: "#fc8181"
    };

    let selectedPhrase = null;
    let isPlaying = false;
    let isRecording = false;
    let speechInterval = null;
    let playDurationTimeout = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordedAudios = [null, null, null, null, null, null];
    let currentPlayCount = 0;
    let targetPlayCount = 0;
    let schedules = [];
    let autoCheckInterval = null;
    let lastCheckedMinute = -1;
    let timerInterval = null;
    let timerTotalSeconds = 0;
    let timerRemainingSeconds = 0;
    let timerRunning = false;
    let decibelMonitoring = false;
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let decibelInterval = null;
    let lastAlertTime = 0;
    let currentAudioElement = null;

    const dataHandler = {
      onDataChanged(data) {
        schedules = data;
        renderScheduleList();
      }
    };

    async function onConfigChange(config) {
      const playerTitle = document.getElementById('player-title');
      const phraseText0 = document.getElementById('phrase-text-0');
      const phraseText1 = document.getElementById('phrase-text-1');
      const phraseText2 = document.getElementById('phrase-text-2');
      const phraseText3 = document.getElementById('phrase-text-3');
      const phraseText4 = document.getElementById('phrase-text-4');
      const phraseText5 = document.getElementById('phrase-text-5');
      const appWrapper = document.querySelector('.app-wrapper');
      const playerContainer = document.querySelector('.player-container');
      const title = document.querySelector('.title');
      const controlBtns = document.querySelectorAll('.control-btn:not(.stop)');
      const stopBtn = document.querySelector('.control-btn.stop');
      const phraseSelect = document.getElementById('schedule-phrase-select');

      playerTitle.textContent = config.player_title || defaultConfig.player_title;
      phraseText0.textContent = config.phrase_1 || defaultConfig.phrase_1;
      phraseText1.textContent = config.phrase_2 || defaultConfig.phrase_2;
      phraseText2.textContent = config.phrase_3 || defaultConfig.phrase_3;
      phraseText3.textContent = config.phrase_4 || defaultConfig.phrase_4;
      phraseText4.textContent = config.phrase_5 || defaultConfig.phrase_5;
      phraseText5.textContent = config.phrase_6 || defaultConfig.phrase_6;

      if (phraseSelect) {
        phraseSelect.innerHTML = `
          <option value="0">ğŸ“¢ ${config.phrase_1 || defaultConfig.phrase_1}</option>
          <option value="1">ğŸª‘ ${config.phrase_2 || defaultConfig.phrase_2}</option>
          <option value="2">ğŸ“ ${config.phrase_3 || defaultConfig.phrase_3}</option>
          <option value="3">ğŸ¤« ${config.phrase_4 || defaultConfig.phrase_4}</option>
          <option value="4">ğŸš¶ ${config.phrase_5 || defaultConfig.phrase_5}</option>
          <option value="5">ğŸ± ${config.phrase_6 || defaultConfig.phrase_6}</option>
        `;
      }

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryActionColor = config.secondary_action_color || defaultConfig.secondary_action_color;

      appWrapper.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${backgroundColor}dd 100%)`;
      playerContainer.style.background = surfaceColor;
      title.style.color = textColor;

      controlBtns.forEach(btn => {
        btn.style.background = primaryActionColor;
        btn.style.boxShadow = `0 4px 12px ${primaryActionColor}66`;
      });

      stopBtn.style.background = secondaryActionColor;
      stopBtn.style.boxShadow = `0 4px 12px ${secondaryActionColor}66`;

      const customFont = config.font_family || defaultConfig.font_family;
      if (customFont) {
        document.body.style.fontFamily = `${customFont}, 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif`;
      }

      const fontSize = config.font_size || 16;
      title.style.fontSize = `${fontSize * 2}px`;
      document.querySelector('.subtitle').style.fontSize = `${fontSize}px`;
      document.querySelectorAll('.phrase-text').forEach(el => {
        el.style.fontSize = `${fontSize * 1.125}px`;
      });
      document.querySelector('.status').style.fontSize = `${fontSize * 0.875}px`;
      document.querySelectorAll('.settings-title').forEach(el => {
        el.style.fontSize = `${fontSize * 1.125}px`;
      });
      document.querySelectorAll('.setting-label').forEach(el => {
        el.style.fontSize = `${fontSize * 0.875}px`;
      });

      renderScheduleList();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              if (window.elementSdk) {
                window.elementSdk.setConfig({ background_color: value });
              }
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              if (window.elementSdk) {
                window.elementSdk.setConfig({ surface_color: value });
              }
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              if (window.elementSdk) {
                window.elementSdk.setConfig({ text_color: value });
              }
            }
          },
          {
            get: () => config.primary_action_color || defaultConfig.primary_action_color,
            set: (value) => {
              config.primary_action_color = value;
              if (window.elementSdk) {
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            }
          },
          {
            get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
            set: (value) => {
              config.secondary_action_color = value;
              if (window.elementSdk) {
                window.elementSdk.setConfig({ secondary_action_color: value });
              }
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            if (window.elementSdk) {
              window.elementSdk.setConfig({ font_family: value });
            }
          }
        },
        fontSizeable: {
          get: () => config.font_size || 16,
          set: (value) => {
            config.font_size = value;
            if (window.elementSdk) {
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["player_title", config.player_title || defaultConfig.player_title],
        ["phrase_1", config.phrase_1 || defaultConfig.phrase_1],
        ["phrase_2", config.phrase_2 || defaultConfig.phrase_2],
        ["phrase_3", config.phrase_3 || defaultConfig.phrase_3],
        ["phrase_4", config.phrase_4 || defaultConfig.phrase_4],
        ["phrase_5", config.phrase_5 || defaultConfig.phrase_5],
        ["phrase_6", config.phrase_6 || defaultConfig.phrase_6]
      ]);
    }

    function speakText(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        speechSynthesis.speak(utterance);
      }
    }

    function playAudio(audioBlob) {
      if (currentAudioElement) {
        currentAudioElement.pause();
        currentAudioElement.currentTime = 0;
      }
      currentAudioElement = new Audio(URL.createObjectURL(audioBlob));
      currentAudioElement.play();
      currentAudioElement.onended = () => {
        currentAudioElement = null;
      };
    }

    function playSelectedPhrase() {
      if (recordedAudios[selectedPhrase]) {
        playAudio(recordedAudios[selectedPhrase]);
      } else {
        const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
        const phraseKey = `phrase_${selectedPhrase + 1}`;
        const phraseText = config[phraseKey] || defaultConfig[phraseKey];
        speakText(phraseText);
      }
    }

    function playPhraseByIndex(phraseIndex) {
      if (recordedAudios[phraseIndex]) {
        playAudio(recordedAudios[phraseIndex]);
      } else {
        const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
        const phraseKey = `phrase_${phraseIndex + 1}`;
        const phraseText = config[phraseKey] || defaultConfig[phraseKey];
        speakText(phraseText);
      }
    }

    function startPlaying() {
      if (selectedPhrase === null) {
        updateStatus('è«‹ï¿½ï¿½é¸æ“‡è¦æ’­æ”¾çš„æé†’èªå¥');
        return;
      }

      const intervalSeconds = parseInt(document.getElementById('interval-input').value) || 3;
      const repeatCount = parseInt(document.getElementById('repeat-input').value) || 0;
      const durationSeconds = parseInt(document.getElementById('play-duration-input').value) || 0;

      isPlaying = true;
      currentPlayCount = 0;
      targetPlayCount = repeatCount;

      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const phraseKey = `phrase_${selectedPhrase + 1}`;
      const phraseText = config[phraseKey] || defaultConfig[phraseKey];
      const mode = recordedAudios[selectedPhrase] ? 'äººè²éŒ„éŸ³' : 'æ–‡å­—è½‰èªéŸ³';
      
      updateStatus(`æ­£åœ¨æ’­æ”¾ï¼š${phraseText}ï¼ˆ${mode}ï¼‰${durationSeconds > 0 ? ` - ${durationSeconds}ç§’å¾Œè‡ªå‹•åœæ­¢` : ''}`);
      updateProgress();
      document.getElementById('progress-info').style.display = 'flex';
      
      playSelectedPhrase();
      currentPlayCount++;
      updateProgress();

      if (durationSeconds > 0) {
        playDurationTimeout = setTimeout(() => {
          stopPlaying();
          updateStatus('æ’­æ”¾æ™‚é–“å·²ï¿½ï¿½ï¿½ï¿½');
        }, durationSeconds * 1000);
      }

      if (targetPlayCount === 0 || currentPlayCount < targetPlayCount) {
        speechInterval = setInterval(() => {
          playSelectedPhrase();
          currentPlayCount++;
          updateProgress();

          if (targetPlayCount > 0 && currentPlayCount >= targetPlayCount) {
            stopPlaying();
            updateStatus('æ’­æ”¾å®Œæˆï¼');
          }
        }, intervalSeconds * 1000);
      } else {
        setTimeout(() => {
          stopPlaying();
          updateStatus('æ’­æ”¾å®Œæˆï¼');
        }, 1000);
      }
    }

    function stopPlaying() {
      isPlaying = false;
      
      if (speechInterval) {
        clearInterval(speechInterval);
        speechInterval = null;
      }

      if (playDurationTimeout) {
        clearTimeout(playDurationTimeout);
        playDurationTimeout = null;
      }
      
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
      }
      
      if (currentAudioElement) {
        currentAudioElement.pause();
        currentAudioElement.currentTime = 0;
        currentAudioElement = null;
      }
      
      if (!isRecording) {
        updateStatus('æ’­æ”¾ï¿½ï¿½åœæ­¢');
      }
      document.getElementById('progress-info').style.display = 'none';
    }

    function updateProgress() {
      document.getElementById('play-count').textContent = currentPlayCount;
      document.getElementById('total-count').textContent = targetPlayCount === 0 ? 'âˆ' : targetPlayCount;
    }

    function updateStatus(message) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      
      statusEl.classList.remove('playing', 'recording');
      if (isPlaying) {
        statusEl.classList.add('playing');
      } else if (isRecording) {
        statusEl.classList.add('recording');
      }
    }

    async function startRecording(phraseIndex) {
      if (isRecording) return;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          recordedAudios[phraseIndex] = audioBlob;
          
          const modeEl = document.getElementById(`phrase-mode-${phraseIndex}`);
          modeEl.textContent = 'äººè²éŒ„éŸ³ âœ“';
          
          stream.getTracks().forEach(track => track.stop());
          isRecording = false;
          updateStatus('éŒ„éŸ³å®Œæˆï¼');
        };

        mediaRecorder.start();
        isRecording = true;
        updateStatus('éŒ„éŸ³ä¸­... ï¿½ï¿½å†æŒ‰ä¸€æ¬¡åœæ­¢');

        const recordBtn = document.querySelector(`.record-btn[data-phrase="${phraseIndex}"]`);
        recordBtn.classList.add('recording');
        recordBtn.innerHTML = '<span>â¹ï¸</span><span>åœæ­¢</span>';

      } catch (error) {
        updateStatus('ç„¡æ³•ä½¿ç”¨éº¥å…‹é¢¨ï¼Œï¿½ï¿½ï¿½ï¿½ï¿½ï¿½æŸ¥æ¬Šé™è¨­å®š');
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        
        document.querySelectorAll('.record-btn').forEach(btn => {
          btn.classList.remove('recording');
          btn.innerHTML = '<span>ğŸ¤</span><span>éŒ„éŸ³</span>';
        });
      }
    }

    function renderScheduleList() {
      const listEl = document.getElementById('schedule-list');
      
      if (schedules.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            å°šæœªæ–°å¢ä»»ä½•æ’ç¨‹<br>
            è«‹åœ¨ä¸Šæ–¹è¡¨å–®æ–°å¢èª²è¡¨æ’ç¨‹
          </div>
        `;
        return;
      }

      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      
      listEl.innerHTML = schedules.map(schedule => {
        const phraseKey = `phrase_${schedule.phrase_index + 1}`;
        const phraseText = config[phraseKey] || defaultConfig[phraseKey];
        const icons = ['ğŸ“¢', 'ğŸª‘', 'ğŸ“', 'ğŸ¤«', 'ğŸš¶', 'ğŸ±'];
        const icon = icons[schedule.phrase_index] || 'ğŸ“¢';
        
        return `
          <div class="schedule-item ${schedule.enabled ? '' : 'disabled'}" data-id="${schedule.__backendId}">
            <div class="schedule-info">
              <div class="schedule-day">${schedule.day}</div>
              <div class="schedule-period">${schedule.period}</div>
              <div class="schedule-phrase">${icon} ${phraseText}</div>
              <div class="schedule-time">${schedule.time}</div>
            </div>
            <div class="schedule-actions">
              <button class="toggle-btn ${schedule.enabled ? '' : 'disabled'}" data-id="${schedule.__backendId}">
                ${schedule.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}
              </button>
              <button class="delete-btn" data-id="${schedule.__backendId}">åˆªï¿½ï¿½</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function addSchedule() {
      const day = document.getElementById('schedule-day').value;
      const period = document.getElementById('schedule-period').value;
      const time = document.getElementById('schedule-time').value;
      const phraseIndex = parseInt(document.getElementById('schedule-phrase-select').value);

      if (!time) {
        updateStatus('è«‹é¸æ“‡æ™‚é–“');
        return;
      }

      if (schedules.length >= 999) {
        const toast = document.createElement('div');
        toast.textContent = 'å·²é”åˆ°æ’ç¨‹ä¸Šé™ï¼ˆ999å€‹ï¼‰';
        toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 16px 24px; border-radius: 8px; z-index: 1000;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
        return;
      }

      const btn = document.getElementById('add-schedule-btn');
      btn.disabled = true;
      btn.innerHTML = 'æ–°å¢ä¸­<span class="spinner"></span>';

      const result = await window.dataSdk.create({
        id: Date.now().toString(),
        day,
        period,
        phrase_index: phraseIndex,
        time,
        enabled: true,
        created_at: new Date().toISOString()
      });

      btn.disabled = false;
      btn.innerHTML = 'æ–°å¢æ’ç¨‹';

      if (result.isOk) {
        document.getElementById('schedule-time').value = '';
      } else {
        const toast = document.createElement('div');
        toast.textContent = 'æ–°å¢å¤±æ•—ï¼Œè«‹é‡è©¦';
        toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 16px 24px; border-radius: 8px; z-index: 1000;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    }

    async function toggleSchedule(scheduleId) {
      const schedule = schedules.find(s => s.__backendId === scheduleId);
      if (!schedule) return;

      schedule.enabled = !schedule.enabled;
      const result = await window.dataSdk.update(schedule);
      
      if (!result.isOk) {
        schedule.enabled = !schedule.enabled;
      }
    }

    async function deleteSchedule(scheduleId) {
      const schedule = schedules.find(s => s.__backendId === scheduleId);
      if (!schedule) return;

      const item = document.querySelector(`[data-id="${scheduleId}"]`);
      const deleteBtn = item.querySelector('.delete-btn');
      
      if (deleteBtn.textContent === 'ç¢ºèªåˆªé™¤ï¼Ÿ') {
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'åˆªé™¤ï¿½ï¿½ï¿½...';
        
        await window.dataSdk.delete(schedule);
        
        deleteBtn.disabled = false;
      } else {
        deleteBtn.textContent = 'ï¿½ï¿½èªåˆªé™¤ï¼Ÿ';
        setTimeout(() => {
          if (deleteBtn) {
            deleteBtn.textContent = 'åˆªé™¤';
          }
        }, 3000);
      }
    }

    function checkSchedules() {
      const now = new Date();
      const currentDay = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸï¿½ï¿½ï¿½', 'æ˜Ÿï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½', 'æ˜ŸæœŸå››', 'æ˜Ÿï¿½ï¿½ï¿½äº”', 'æ˜ŸæœŸå…­'][now.getDay()];
      const currentTime = now.toTimeString().slice(0, 5);
      const currentMinute = now.getHours() * 60 + now.getMinutes();

      if (currentMinute === lastCheckedMinute) {
        return;
      }
      lastCheckedMinute = currentMinute;

      schedules.forEach(schedule => {
        if (schedule.enabled && schedule.day === currentDay && schedule.time === currentTime) {
          playPhraseByIndex(schedule.phrase_index);
          
          const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
          const phraseKey = `phrase_${schedule.phrase_index + 1}`;
          const phraseText = config[phraseKey] || defaultConfig[phraseKey];
          
          const toast = document.createElement('div');
          toast.textContent = `ğŸ”” è‡ªå‹•æ’­æ”¾ï¼š${schedule.period} - ${phraseText}`;
          toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 16px 24px; border-radius: 8px; z-index: 1000; font-weight: 600;';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 5000);
        }
      });
    }

    function updateCurrentTime() {
      const now = new Date();
      const timeStr = now.toTimeString().slice(0, 8);
      document.getElementById('current-time').textContent = timeStr;
    }

    function formatTimerDisplay(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
      const display = document.getElementById('timer-display');
      display.textContent = formatTimerDisplay(timerRemainingSeconds);
    }

    function setTimer(minutes, seconds) {
      timerTotalSeconds = minutes * 60 + seconds;
      timerRemainingSeconds = timerTotalSeconds;
      updateTimerDisplay();
      stopTimer();
    }

    function startTimer() {
      if (timerRemainingSeconds <= 0) return;

      timerRunning = true;
      const display = document.getElementById('timer-display');
      display.classList.add('running');
      display.classList.remove('finished');

      document.getElementById('timer-start-btn').disabled = true;
      document.getElementById('timer-pause-btn').disabled = false;

      timerInterval = setInterval(() => {
        timerRemainingSeconds--;
        updateTimerDisplay();

        if (timerRemainingSeconds <= 0) {
          timerFinished();
        }
      }, 1000);
    }

    function pauseTimer() {
      timerRunning = false;
      clearInterval(timerInterval);
      
      const display = document.getElementById('timer-display');
      display.classList.remove('running');

      document.getElementById('timer-start-btn').disabled = false;
      document.getElementById('timer-pause-btn').disabled = true;
    }

    function stopTimer() {
      timerRunning = false;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      const display = document.getElementById('timer-display');
      display.classList.remove('running', 'finished');

      document.getElementById('timer-start-btn').disabled = false;
      document.getElementById('timer-pause-btn').disabled = true;
    }

    function resetTimer() {
      timerRemainingSeconds = timerTotalSeconds;
      updateTimerDisplay();
      stopTimer();
    }

    async function startDecibelMonitoring() {
      if (decibelMonitoring) return;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        
        analyser.fftSize = 512;
        microphone.connect(analyser);
        
        decibelMonitoring = true;
        document.getElementById('decibel-start-btn').disabled = true;
        document.getElementById('decibel-stop-btn').disabled = false;
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        decibelInterval = setInterval(() => {
          analyser.getByteFrequencyData(dataArray);
          
          // è¨ˆç®— RMS (å‡æ–¹æ ¹) ç²å¾—æ›´ç²¾æº–çš„éŸ³é‡
          let sumSquares = 0;
          for (let i = 0; i < dataArray.length; i++) {
            const normalized = dataArray[i] / 255.0;
            sumSquares += normalized * normalized;
          }
          const rms = Math.sqrt(sumSquares / dataArray.length);
          
          // ä½¿ç”¨æ›´ç²¾æº–çš„åˆ†è²è¨ˆç®—å…¬å¼ï¼Œæ ¡æº–åˆ°å¯¦éš›ç’°å¢ƒéŸ³é‡
          const decibel = Math.round(20 * Math.log10(rms * 100 + 1) + 30);
          
          const display = document.getElementById('decibel-display');
          display.textContent = `${decibel} dB`;
          
          if (decibel < 50) {
            display.style.color = '#10b981';
          } else if (decibel < 70) {
            display.style.color = '#fbbf24';
          } else if (decibel < 85) {
            display.style.color = '#f97316';
          } else {
            display.style.color = '#ef4444';
          }
          
          const alertEnabled = document.getElementById('decibel-alert-enabled').checked;
          const threshold = parseInt(document.getElementById('decibel-threshold').value);
          const cooldown = parseInt(document.getElementById('decibel-cooldown').value) * 1000;
          const now = Date.now();
          
          if (alertEnabled && decibel >= threshold && (now - lastAlertTime) >= cooldown) {
            lastAlertTime = now;
            const phraseIndex = parseInt(document.getElementById('decibel-alert-phrase').value);
            playPhraseByIndex(phraseIndex);
            
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            const phraseKey = `phrase_${phraseIndex + 1}`;
            const phraseText = config[phraseKey] || defaultConfig[phraseKey];
            
            const statusEl = document.getElementById('decibel-status');
            const lastAlertEl = document.getElementById('decibel-last-alert');
            statusEl.style.display = 'block';
            lastAlertEl.textContent = `${decibel} dB - ${phraseText} (${new Date().toLocaleTimeString()})`;
            
            const toast = document.createElement('div');
            toast.textContent = `ğŸ”Š éŸ³é‡éé«˜ (${decibel} dB)ï¼š${phraseText}`;
            toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 16px 24px; border-radius: 8px; z-index: 1000; font-weight: 600;';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
          }
        }, 100);
        
      } catch (error) {
        const toast = document.createElement('div');
        toast.textContent = 'ç„¡æ³•ä½¿ç”¨éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
        toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 16px 24px; border-radius: 8px; z-index: 1000;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    }

    function stopDecibelMonitoring() {
      if (!decibelMonitoring) return;

      decibelMonitoring = false;
      
      if (decibelInterval) {
        clearInterval(decibelInterval);
        decibelInterval = null;
      }
      
      if (microphone) {
        microphone.disconnect();
        microphone = null;
      }
      
      if (analyser) {
        analyser = null;
      }
      
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      
      document.getElementById('decibel-display').textContent = '-- dB';
      document.getElementById('decibel-display').style.color = 'white';
      document.getElementById('decibel-start-btn').disabled = false;
      document.getElementById('decibel-stop-btn').disabled = true;
    }

    function timerFinished() {
      stopTimer();
      
      const display = document.getElementById('timer-display');
      display.classList.add('finished');

      const alertEnabled = document.getElementById('timer-alert-enabled').checked;
      if (alertEnabled) {
        const phraseIndex = parseInt(document.getElementById('timer-alert-phrase').value);
        playPhraseByIndex(phraseIndex);
      }

      const toast = document.createElement('div');
      toast.textContent = 'â° è¨ˆæ™‚å®Œæˆï¼';
      toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 16px 24px; border-radius: 8px; z-index: 1000; font-weight: 600; font-size: 18px;';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);

      setTimeout(() => {
        display.classList.remove('finished');
      }, 1500);
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(`${tab}-tab`).classList.add('active');
      });
    });

    document.getElementById('phrase-list').addEventListener('click', (e) => {
      if (e.target.closest('.record-btn')) {
        return;
      }

      const phraseItem = e.target.closest('.phrase-item');
      if (!phraseItem) return;

      document.querySelectorAll('.phrase-item').forEach(item => {
        item.classList.remove('active');
      });
      
      phraseItem.classList.add('active');
      selectedPhrase = parseInt(phraseItem.dataset.phrase);
      
      if (!isPlaying && !isRecording) {
        const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
        const phraseKey = `phrase_${selectedPhrase + 1}`;
        const phraseText = config[phraseKey] || defaultConfig[phraseKey];
        const mode = recordedAudios[selectedPhrase] ? 'äººè²éŒ„éŸ³' : 'æ–‡å­—è½‰èªéŸ³';
        updateStatus(`å·²é¸æ“‡ï¼š${phraseText}ï¼ˆ${mode}ï¼‰`);
      }
    });

    document.querySelectorAll('.record-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const phraseIndex = parseInt(btn.dataset.phrase);
        
        if (isRecording) {
          stopRecording();
        } else {
          startRecording(phraseIndex);
        }
      });
    });

    document.getElementById('play-btn').addEventListener('click', () => {
      if (!isPlaying && !isRecording) {
        startPlaying();
      }
    });

    document.getElementById('stop-btn').addEventListener('click', () => {
      if (isRecording) {
        stopRecording();
      } else {
        stopPlaying();
      }
    });

    document.getElementById('add-schedule-btn').addEventListener('click', addSchedule);

    document.getElementById('schedule-list').addEventListener('click', (e) => {
      const toggleBtn = e.target.closest('.toggle-btn');
      const deleteBtn = e.target.closest('.delete-btn');

      if (toggleBtn) {
        const scheduleId = toggleBtn.dataset.id;
        toggleSchedule(scheduleId);
      } else if (deleteBtn) {
        const scheduleId = deleteBtn.dataset.id;
        deleteSchedule(scheduleId);
      }
    });

    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const minutes = parseInt(btn.dataset.minutes);
        setTimer(minutes, 0);
      });
    });

    document.getElementById('set-timer-btn').addEventListener('click', () => {
      const minutes = parseInt(document.getElementById('timer-minutes').value) || 0;
      const seconds = parseInt(document.getElementById('timer-seconds').value) || 0;
      setTimer(minutes, seconds);
    });

    document.getElementById('timer-start-btn').addEventListener('click', () => {
      if (!timerRunning) {
        startTimer();
      }
    });

    document.getElementById('timer-pause-btn').addEventListener('click', () => {
      if (timerRunning) {
        pauseTimer();
      }
    });

    document.getElementById('timer-reset-btn').addEventListener('click', () => {
      resetTimer();
    });

    document.getElementById('decibel-start-btn').addEventListener('click', () => {
      startDecibelMonitoring();
    });

    document.getElementById('decibel-stop-btn').addEventListener('click', () => {
      stopDecibelMonitoring();
    });

    async function init() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }

      autoCheckInterval = setInterval(() => {
        updateCurrentTime();
        checkSchedules();
      }, 1000);

      updateCurrentTime();
      setTimer(5, 0);
      document.getElementById('timer-pause-btn').disabled = true;
      document.getElementById('decibel-stop-btn').disabled = true;
      onConfigChange(defaultConfig);
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ae2c8a630f2841c',t:'MTc2NTc2ODYwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
